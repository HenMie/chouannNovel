# 前端优化与开发计划 (Optimization Plan)

基于对当前代码库的深入分析，以下是后续的优化和开发计划。

---

## 1. 性能优化 (Performance)

### 已完成 ✅
- [x] **列表虚拟化**: 对执行历史、设定库等可能包含大量项目的列表，引入虚拟滚动 (`@tanstack/react-virtual`)。
  - 新增 `VirtualList` 和 `VirtualGrid` 通用组件
  - 执行历史页面使用 `VirtualExecutionList` 组件
  - 设定库页面使用 `VirtualSettingsList` 组件（列表 ≥20 项时启用）
- [x] **数据库索引优化**: 为高频查询字段添加数据库索引。
  - `workflows`: project_id, updated_at
  - `nodes`: workflow_id, order_index
  - `settings`: project_id, category, name
  - `executions`: workflow_id, started_at
  - `node_results`: execution_id, node_id, started_at
- [x] **请求防抖与节流**: 优化搜索、输入等场景的请求频率。
  - 新增 `debounce`、`throttle` 工具函数
  - 新增 `useDebouncedValue`、`useDebouncedCallback`、`useThrottledCallback` React Hooks
  - 设定库搜索使用 300ms 防抖
- [x] **图片与资源优化**: 引入图片懒加载和资源压缩。
  - 新增 `LazyImage` 和 `LazyBackgroundImage` 组件
  - Vite 构建配置优化：代码分割、压缩、移除 console/debugger

---

## 2. 功能增强 (Feature Enhancements)

### 核心功能
- [x] **工作流导入/导出**: 实现工作流的 JSON 格式导入导出功能，支持跨项目复用。
  - 工作流页面添加"导出工作流"和"导入工作流"功能
  - 支持完整的节点配置和块结构保存
- [x] **项目备份与恢复**: 完整的项目数据备份（含设定库、工作流）和一键恢复功能。
  - 项目页面添加"导出项目备份"功能
  - 首页添加"导入项目"功能，支持从备份文件恢复
  - 设定库支持单独的导入/导出（合并或替换模式）
- [x] **工作流版本历史**: 自动保存工作流编辑历史，支持版本回滚。
  - 添加 `workflow_versions` 数据库表
  - 工作流页面添加"保存版本"和"恢复版本"功能
  - 支持版本描述和最近版本列表

### 编辑器增强
- [x] **撤销/重做功能**: 节点编辑操作的撤销（Ctrl+Z）和重做（Ctrl+Shift+Z/Ctrl+Y）支持。
  - 新增 `useWorkflowHistory` Hook 管理操作历史
  - 支持添加、删除、重排序、批量删除等操作的撤销重做
  - 工具栏添加撤销/重做按钮
- [x] **节点复制增强**: 支持跨工作流的节点复制粘贴。
  - 增强 `project-store` 支持批量复制粘贴
  - 跨工作流粘贴时自动生成新的块 ID
  - 粘贴按钮显示复制的节点数量
- [x] **批量节点操作**: 多选节点进行批量删除、移动、复制。
  - 新增 `useNodeSelection` Hook 管理多选状态
  - 支持 Ctrl+点击切换选择、Shift+点击范围选择
  - Ctrl+A 全选、Delete/Backspace 删除、Ctrl+C 复制
  - 选中节点时显示批量操作工具栏

### 设定库增强
- [ ] **批量操作**: 批量启用/禁用、删除设定条目。
- [ ] **设定导入导出**: 单独导入导出设定库数据。
- [ ] **设定模板**: 预设角色、世界观等常用设定模板。
- [ ] **设定关联**: 设定条目之间的关联和引用关系。

### 执行增强
- [ ] **执行队列**: 支持排队执行多个工作流任务。
- [ ] **定时执行**: 设置工作流的定时自动执行。
- [ ] **断点调试**: 在指定节点处暂停执行，检查中间状态。
- [ ] **执行日志导出**: 将执行记录导出为详细日志文件。

---

## 3. 用户体验 (UX Improvements)

### 引导与帮助
- [ ] **新手引导 (Onboarding)**: 首次使用时的交互式引导教程。
- [ ] **节点说明文档**: 每种节点类型的详细使用说明和示例。
- [ ] **快捷键提示**: 全局快捷键一览表（可通过 `?` 或 `F1` 打开）。

### 可视化增强
- [ ] **工作流可视化**: 流程图样式的节点可视化展示（可选视图）。
- [ ] **数据流指示**: 可视化显示节点之间的数据传递路径。
- [ ] **执行进度条**: 更直观的工作流执行进度展示。
- [ ] **统计图表**: 项目仪表盘添加执行统计图表（执行次数、字数趋势等）。

### 交互优化
- [ ] **拖拽上传**: 支持拖拽文件导入项目或工作流。
- [ ] **右键菜单**: 完善节点和列表项的右键上下文菜单。
- [ ] **多标签页**: 支持同时打开多个工作流进行编辑。
- [ ] **窗口布局记忆**: 记住用户调整的面板大小和布局。

---

## 4. 代码质量 (Code Quality)

### 错误处理
- [ ] **Error Boundary**: 添加 React Error Boundary 捕获组件渲染错误，提供友好的错误提示页面。
- [ ] **全局错误处理**: 统一的 API 错误处理和用户反馈机制。

### 日志与监控
- [ ] **日志系统**: 引入统一的日志管理工具，替换分散的 `console.log/error` 调用（当前约 30 处）。
- [ ] **性能监控**: 添加关键操作的性能埋点。

### 测试覆盖
- [ ] **单元测试**: 为核心工具函数和 hooks 添加单元测试。
- [ ] **组件测试**: 为关键 UI 组件添加组件测试。
- [ ] **E2E 测试**: 添加端到端测试覆盖主要用户流程。

### 类型安全
- [ ] **消除 @ts-ignore**: 修复所有 TypeScript 类型问题，移除 `@ts-ignore` 注释。
- [ ] **严格类型检查**: 启用 TypeScript 严格模式。

---

## 优先级说明

| 优先级 | 描述 | 建议范围 |
|--------|------|----------|
| P0 | 阻塞性问题，需立即解决 | 错误处理、类型安全 |
| P1 | 核心功能，近期完成 | 工作流导入导出、列表虚拟化 |
| P2 | 重要改进，中期完成 | 撤销重做、可视化增强 |
| P3 | 锦上添花，长期规划 | 国际化、插件系统 |

---

*最后更新: 2025-12-03* (性能优化、核心功能增强和编辑器增强已完成)
