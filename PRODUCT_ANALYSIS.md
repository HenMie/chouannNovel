# ChouannNovel 产品分析报告

> 分析日期: 2026-02-12
> 分析范围: 使用逻辑、功能缺陷、可优化点
> 分析方法: 全量代码审查（页面路由、工作流系统、执行引擎、AI 集成、数据层）

---

## 目录

1. [执行摘要](#1-执行摘要)
2. [严重缺陷（需立即修复）](#2-严重缺陷需立即修复)
3. [功能缺失（高优先级）](#3-功能缺失高优先级)
4. [使用逻辑问题](#4-使用逻辑问题)
5. [性能与可扩展性](#5-性能与可扩展性)
6. [UX 可优化点](#6-ux-可优化点)
7. [功能增强建议（中低优先级）](#7-功能增强建议中低优先级)
8. [优先级汇总矩阵](#8-优先级汇总矩阵)

---

## 1. 执行摘要

ChouannNovel 在核心功能（工作流编辑、AI 多提供商集成、设定库层级化、流式输出）上完成度较高。但代码审查发现 **3 个数据丢失 Bug**、**执行引擎在暂停编辑和并发错误处理上的逻辑缺陷**、以及 **Token 用量/成本追踪完全缺失** 等关键问题。以下按严重程度分级呈现。

---

## 2. 严重缺陷（需立即修复）

> ✅ 修复状态（2026-02-12）：2.1 / 2.2 / 2.3 已修复并通过对应单元测试。

### 2.1 设定库导入丢失层级结构 🔴

**修复状态**: ✅ 已修复（2026-02-12）

**修复内容**:
- `importSettings()` 与 `importProject()` 导入逻辑改为两阶段：先插入，再基于导出 `id` 映射回填 `parent_id`
- 导入 SQL 已补充 `parent_id` 与 `order_index`
- 导出 `settings` 增加 `id` 字段用于导入时父子关系映射

**验证**:
- `src/lib/db/__tests__/index.test.ts` 新增层级保留测试并通过

**影响**: 用户导入设定备份后，所有 parent_id 和 order_index 丢失，层级结构变为扁平列表。

**位置**:
- `src/lib/db/index.ts:1125-1133` — `importSettings()` 的 INSERT 缺少 `parent_id` 和 `order_index` 列
- `src/lib/db/index.ts:1286-1293` — `importProject()` 中同样缺失

**现状**: 导出函数 (`exportProject`, `exportSettings`) 正确保存了 `parent_id` 和 `order_index`，但导入函数未将其写入数据库。

**修复方向**: INSERT 语句中补充 `parent_id` 和 `order_index` 字段，并处理旧 ID 到新 ID 的映射。

---

### 2.2 暂停编辑不影响后续执行 🔴

**修复状态**: ✅ 已修复（2026-02-12）

**修复内容**:
- `modifyNodeOutput()` 在更新 `nodeState` 与 `nodeOutput` 映射外，新增同步更新变量映射
- 暂停人工改写后，后续节点通过变量引用可读取最新值

**验证**:
- `src/lib/engine/__tests__/executor.test.ts` 全量通过

**影响**: 用户在暂停期间手动修改节点输出后恢复执行，后续节点仍使用旧值。

**位置**:
- `src/lib/engine/executor.ts:1507-1536` — `modifyNodeOutput()` 仅更新 UI 和 nodeState
- 通过 `{{变量名}}` 引用的变量未同步更新

**分析**:
```
用户暂停 → 编辑节点 A 输出为 "新内容"
           → context.setNodeOutput("新内容", nodeA_id)  ✅ 更新了
           → 但 context.setVariable() 未被调用            ❌ 变量未更新
节点 B 引用 {{变量名}} → 拿到旧值                          ❌ 用户修改被忽略
```

**用户预期**: "我暂停修改了输出，恢复后应该用新内容继续"
**实际行为**: 修改仅为 UI 展示，后续节点可能使用旧值

---

### 2.3 并发执行静默吞错 🔴

**修复状态**: ✅ 已修复（2026-02-12）

**修复内容**:
- 并发执行改为严格失败策略：子任务重试耗尽后抛错并终止工作流
- 新增自动重试机制，支持节点配置 `retry_count`（默认 3 次）
- 前端并发配置新增“失败重试次数”可视化设置

**验证**:
- `src/lib/engine/__tests__/executor.test.ts` 新增并发重试成功/失败/默认值测试并通过

**影响**: 并发块中某分支失败时，错误被 catch 捕获并返回空字符串，用户无法感知哪条分支失败。

**位置**: `src/lib/engine/executor.ts:1313-1327`

```typescript
catch (error) {
  logError({ error, context: `并发执行节点 ${parallelNode.name}` })
  return ''  // 静默返回空字符串，不通知用户
}
```

**后果**:
- 工作流继续执行，仿佛一切正常
- 并发输出中混入空字符串，但无标识
- 用户难以判断是"没有输出"还是"执行出错"

---

## 3. 功能缺失（高优先级）

### 3.1 Token 用量与成本追踪 — 已修复（节点级 + 成本估算）

**已完成（本轮）**:
- AI SDK `usage`（promptTokens, completionTokens, totalTokens）已贯通到节点执行结果
- `node_results` 已落库 `token_usage` 数据
- 执行历史页已展示节点级 token 用量（含兜底与格式化）
- 基于模型定价的成本估算（`estimateTokenCost` + `formatCost`），执行历史中以绿色显示

**仍缺失**:
- 项目/全局维度的用量统计与仪表盘
### 3.2 AI 请求重试机制 — 已修复

**已完成（本轮）**:
- AI 节点支持自动重试，前端可配置 `retry_count`
- 默认重试次数为 3 次（用户可手动调整）
- 采用指数退避策略处理瞬时故障（如网络波动、限流）
- 达到最大重试次数后保留失败信息并终止当前节点

**仍可增强**:
- 备用提供商自动切换
- 断路器与更细粒度重试策略
### 3.3 项目复制功能 — 已修复

**已完成（本轮）**:
- `duplicateProject()` 函数基于 export/import 实现一键复制
- 首页项目卡片和侧边栏均添加"复制"菜单项
- 复制后自动命名为"原名 (副本)"

### 3.4 项目组织能力 — 缺失

| 功能 | 状态 |
|------|------|
| 项目文件夹/分组 | ❌ 缺失 |
| 项目标签/分类 | ❌ 缺失 |
| 项目模板 | ❌ 缺失 |
| 跨项目全局搜索 | ❌ 缺失 |
| 工作流文件夹 | ❌ 缺失 |
| 收藏/置顶项目 | ❌ 缺失 |

当项目数量超过 20+ 时，扁平列表的管理效率会显著下降。

### 3.5 执行历史对比功能 — 缺失

- 无法并排对比两次执行的输出
- 无法 diff 查看变更
- 无法从历史执行中"重放"（使用相同输入重新运行）
- `variables_snapshot` 已保存到数据库但 UI 未展示

---

## 4. 使用逻辑问题

### 4.1 暂停无法中断正在进行的 AI 流（已修复）

**位置**: `executor.ts:571-605`

当前已支持在 AI 流式输出期间响应暂停：
- 暂停时会中断当前 AI 流
- 执行状态保持为可恢复的暂停态，而非失败态
- 用户恢复后可继续后续执行流程
### 4.2 超时检测精度不足

**位置**: `executor.ts:180-185`

`context.isTimeout()` 仅在节点之间检查，不在节点执行期间检查。一个 10 分钟的 AI 调用在 5 分钟超时的工作流中会继续执行直到完成。

### 4.3 变量引用静默失败（已修复）

**位置**: `context.ts:102-133`

当前变量插值已改为严格模式：
- 当模板引用不存在变量（如 `{{不存在的变量}}`）时立即抛错
- 节点执行明确失败并暴露错误信息，避免静默吞错
- 便于在调试阶段快速定位变量缺失问题
### 4.4 新旧节点类型共存造成混乱

系统中存在两套控制结构节点：
- 旧版: `condition`, `loop`, `batch`（独立节点）
- 新版: `condition_if`/`condition_else`/`condition_end`, `loop_start`/`loop_end`, `parallel_start`/`parallel_end`（结构化块）

两套节点均可创建，但行为和配置方式不同。对新用户而言，"条件判断"和"条件分支"的区别不直观。

**建议**: 考虑在 UI 中隐藏旧版节点，或添加明确的"推荐"/"旧版"标记。

### 4.5 `NewWorkflowPage` 使用 `useState` 作为初始化逻辑

**位置**: `src/pages/NewWorkflowPage.tsx:26-34`

```typescript
useState(() => {
  if (!currentProject) {
    const { projects } = useProjectStore.getState()
    // ...
  }
})
```

这是对 `useState` 的误用 — 将初始化器函数当作 `useEffect` 使用。虽然功能可行，但语义不正确，可能在 React 严格模式下产生问题。

### 4.6 取消执行后的数据库残留

**位置**: `execution-store.ts:192-205`

执行被取消时，已保存的 `node_results` 记录不会被清理。长期使用后数据库中会积累大量孤儿记录。

---

## 5. 性能与可扩展性

### 5.1 流式输出 Markdown 全量重渲染

**位置**: `src/components/execution/StreamingOutput.tsx:73-76`

```typescript
<MarkdownRenderer content={content + (isStreaming ? ' ▍' : '')} />
```

每收到一个流式 chunk（约 100ms 一次），整个 Markdown 内容被重新解析渲染。对于长输出（>10KB），存在 O(n²) 复杂度问题，可能导致 UI 卡顿。

**建议**: 采用增量渲染或 diff-based 更新策略。

### 5.2 事件处理异步间隙

**位置**: `execution-store.ts:128-133`

`onEvent` 回调为 async 但未被 await，导致 Store 状态更新与 API chunk 到达之间存在 50-200ms 感知延迟。

### 5.3 无分页机制

| 查询 | 位置 | 风险 |
|------|------|------|
| `getProjects()` | `db/index.ts:78-81` | 1000+ 项目时变慢 |
| `getWorkflowVersions()` | `db/index.ts:1319-1326` | 版本不断累积 |
| 执行历史 | `ExecutionHistoryPage.tsx` | 已用虚拟滚动缓解 |

### 5.4 设定库树构建 O(n²)

**位置**: `settings-store.ts:220-235` — `getSettingTree()` 在构建层级树时可能对大量设定产生性能问题（>1000 条时明显）。

---

## 6. UX 可优化点

### 6.1 AI 配置缺少预设 — 已修复

**已完成**: AIChatConfig 新增创意/均衡/精确三种预设按钮，一键设置 temperature + topP。

### 6.2 设定库缺少拖拽排序

层级设定支持 parent-child 关系展示，但不支持拖拽调整顺序和层级归属。用户必须通过表单手动修改 parent。

**建议**: 添加 dnd-kit 拖拽排序支持（工作流节点已有此能力）。

### 6.3 设定详情缺少面包屑 — 已修复

**已完成**: 右侧详情面板新增面包屑导航，选中子设定时显示完整层级路径，可点击跳转到祖先设定。

### 6.4 执行历史缺少筛选 — 部分修复

| 功能 | 状态 |
|------|------|
| 按状态筛选（成功/失败/取消） | ✅ 已修复 |
| 按日期范围筛选 | ❌ 缺失 |
| 按执行时长筛选 | ❌ 缺失 |
| 按输入/输出关键词搜索 | ✅ 已修复 |
| 变量快照可视化 | ❌ 缺失 |

### 6.5 节点配置缺少预验证 — 已修复

**已完成**: AIChatConfig 新增 useMemo 实时验证，检查未选模型、空提示词等问题，以琥珀色警告显示。

### 6.6 流式输出无停滞指示 — 已修复

**已完成**: StreamingOutput 新增 30 秒停滞检测，超时后显示琥珀色警告提示网络问题或 API 中断。

### 6.7 跨节点对话历史不互通

**位置**: `executor.ts:610-616`

每个 AI 节点维护独立的对话历史。如果工作流中有多个 AI 节点需要共享上下文，用户必须手动通过变量传递输出。

**建议**: 提供可选的"共享对话上下文"模式。

### 6.8 并发结果变量命名不友好

并发块的结果存储为 `_parallel_{blockId}_results`，使用 UUID 作为键名。用户必须知道 block_id 才能引用结果，缺少别名机制。

---

## 7. 功能增强建议（中低优先级）

### 7.1 执行结果导出增强

当前仅支持 TXT 和 Markdown 导出。建议增加:
- **JSON 导出**: 便于程序化处理和重新导入
- **HTML 导出**: 保留格式的可视化报告
- 导出中包含 `resolved_config`（使用的模型、设定等）

### 7.2 工作流节点可视化画布

当前节点以列表形式展示（`WorkflowNodeTree`），对于复杂的分支/循环/并发结构，缺少流程图式的可视化。

### 7.3 键盘快捷键扩展

现有快捷键覆盖了基本操作（Ctrl+S 保存、Ctrl+Enter 运行等）。可增加:
- Ctrl+Z / Ctrl+Shift+Z 用于撤销/重做节点操作
- Tab 在节点间快速切换
- Ctrl+D 快速复制当前节点

### 7.4 设定注入模板增强

当前模板系统使用简单的 `{{#each items}}` 语法，可增加:
- 条件渲染 (`{{#if enabled}}`)
- 自定义格式化函数
- 模板预览功能

### 7.5 数据库维护功能

- 导出/备份数据库
- 清理孤儿记录
- 数据库大小统计
- 旧执行记录自动清理（保留策略）

### 7.6 全局设置增强

缺失项:
- 隐私/遥测开关
- 快捷键自定义
- 数据目录设置
- 危险操作区（重置数据等）

---

## 8. 优先级汇总矩阵

### P0 - 数据丢失 / 逻辑错误（立即修复）

| # | 问题 | 位置 | 类型 |
|---|------|------|------|
| 1 | 设定导入丢失 parent_id/order_index（已修复） | `db/index.ts:1125-1133, 1286-1293` | Bug |
| 2 | 暂停编辑不更新变量状态（已修复） | `executor.ts:1507-1536` | 逻辑缺陷 |
| 3 | 并发执行静默吞错（已修复） | `executor.ts:1313-1327` | 逻辑缺陷 |

### P1 - 核心功能缺失（近期迭代）

| # | 问题 | 影响 |
|---|------|------|
| 4 | Token 用量/成本追踪（节点级+成本估算已修复，仪表盘待补） | 可追踪节点用量和估算费用 |
| 5 | AI 请求重试机制（已修复） | 网络波动不再直接终止工作流 |
| 6 | 暂停无法中断 AI 流（已修复） | 长响应期间可暂停并恢复 |
| 7 | 变量引用静默失败（已修复） | 变量缺失可快速定位 |
| 8 | 项目复制（已修复） | 一键复制项目含工作流和设定 |
| 9 | 执行历史对比/重放 | 迭代优化困难 |

### P2 - 体验优化（中期迭代）

| # | 问题 | 影响 |
|---|------|------|
| 10 | 项目文件夹/标签组织 | 大量项目管理困难 |
| 11 | 流式 Markdown 全量重渲染（已修复） | 节流 150ms 避免卡顿 |
| 12 | 设定库拖拽排序 | 层级调整操作繁琐 |
| 13 | 节点配置预验证（已修复） | 实时警告未配置项 |
| 14 | 执行历史筛选/搜索（已修复） | 状态筛选+关键词搜索 |
| 15 | 新旧节点类型混乱（已修复） | 块节点标记"推荐" |
| 16 | 跨节点对话历史共享 | 多轮 AI 场景受限 |

### P3 - 锦上添花（长期规划）

| # | 问题 | 影响 |
|---|------|------|
| 17 | JSON 执行结果导出（已修复） | 结构化 JSON 导出 |
| 18 | 工作流画布可视化 | 复杂流程可读性 |
| 19 | AI 参数预设模式（已修复） | 创意/均衡/精确一键切换 |
| 20 | 数据库维护工具 | 长期使用健康度 |
| 21 | 流式输出停滞检测（已修复） | 30s 超时警告 |
| 22 | 并发结果变量别名 | 易用性 |
| 23 | 取消执行清理孤儿记录（已修复） | 孤儿节点标记 failed |

---

## 附录: 关键代码引用

| 文件 | 行数 | 审查要点 |
|------|------|----------|
| `src/lib/db/index.ts` | ~1400 | 设定导入 Bug、数据持久化 |
| `src/lib/engine/executor.ts` | ~1450 | 暂停/恢复逻辑、并发错误、AI 流中断 |
| `src/lib/engine/context.ts` | ~340 | 变量插值、静默失败 |
| `src/stores/execution-store.ts` | ~380 | 事件异步间隙、状态管理 |
| `src/components/execution/StreamingOutput.tsx` | ~97 | Markdown 重渲染性能 |
| `src/pages/SettingsLibraryPage.tsx` | ~1650 | 设定库 UX |
| `src/pages/ExecutionHistoryPage.tsx` | ~670 | 历史筛选/对比缺失 |
| `src/components/node/WorkflowNodeTree.tsx` | ~1361 | 节点系统复杂度 |
| `src/lib/ai/index.ts` | ~624 | AI 集成、错误处理、Token 追踪 |
| `src/pages/NewWorkflowPage.tsx` | 26-34 | useState 误用 |


